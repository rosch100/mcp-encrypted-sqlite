name: Publish to MCP Registry

on:
  release:
    types: [published]
  workflow_run:
    workflows: ["Sync Versions on Release"]
    types:
      - completed
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to publish (e.g., 0.2.4)'
        required: false

env:
  REGISTRY_URL: https://registry.modelcontextprotocol.io

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write  # Required for GitHub OIDC
    
    steps:
    - name: Check if sync-versions completed successfully
      if: github.event_name == 'workflow_run'
      run: |
        if [ "${{ github.event.workflow_run.conclusion }}" != "success" ]; then
          echo "❌ Sync Versions workflow did not complete successfully"
          echo "Conclusion: ${{ github.event.workflow_run.conclusion }}"
          exit 1
        fi
        echo "✅ Sync Versions workflow completed successfully"
    
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Extract version from tag, workflow_run, or input
      id: version
      run: |
        if [ "${{ github.event_name }}" == "release" ]; then
          VERSION="${{ github.event.release.tag_name }}"
          # Remove 'v' prefix if present
          VERSION=${VERSION#v}
        elif [ "${{ github.event_name }}" == "workflow_run" ]; then
          # When triggered by workflow_run, read version from server.json
          # The sync-versions workflow should have already updated it
          VERSION=$(jq -r '.version' server.json)
          if [ -z "$VERSION" ] || [ "$VERSION" = "null" ]; then
            echo "❌ Could not extract version from server.json"
            exit 1
          fi
          echo "Extracted version from server.json: $VERSION"
        else
          VERSION="${{ github.event.inputs.version }}"
        fi
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Publishing version: $VERSION"
    
    - name: Validate server.json
      id: validate
      run: |
        if ! command -v jq &> /dev/null; then
          sudo apt-get update && sudo apt-get install -y jq
        fi
        echo "Validating server.json..."
        jq . server.json > /dev/null
        echo "✅ server.json is valid JSON"
        
        # Check if version matches
        SERVER_VERSION=$(jq -r '.version' server.json)
        RELEASE_VERSION="${{ steps.version.outputs.version }}"
        echo "Server.json version: $SERVER_VERSION"
        echo "Release version: $RELEASE_VERSION"
        
        if [ "$SERVER_VERSION" != "$RELEASE_VERSION" ]; then
          echo "⚠️  WARNING: Version mismatch!"
          echo "   server.json has: $SERVER_VERSION"
          echo "   Release tag has: $RELEASE_VERSION"
          echo "   Using server.json version for publishing"
          echo "version=$SERVER_VERSION" >> $GITHUB_OUTPUT
          echo "version_mismatch=true" >> $GITHUB_OUTPUT
        else
          echo "✅ Versions match"
          echo "version_mismatch=false" >> $GITHUB_OUTPUT
        fi
    
    - name: Install mcp-publisher
      run: |
        echo "Installing mcp-publisher..."
        set -e  # Exit on error
        
        # Download binary directly (GitHub Actions runs on Ubuntu, no brew)
        ARCH=$(uname -m)
        OS=$(uname -s | tr '[:upper:]' '[:lower:]')
        if [ "$ARCH" = "x86_64" ]; then
          ARCH="amd64"
        elif [ "$ARCH" = "aarch64" ]; then
          ARCH="arm64"
        fi
        
        VERSION="1.3.10"
        # URL format: mcp-publisher_linux_amd64.tar.gz (no version in filename)
        URL="https://github.com/modelcontextprotocol/registry/releases/download/v${VERSION}/mcp-publisher_${OS}_${ARCH}.tar.gz"
        
        echo "Detected OS: $OS, Arch: $ARCH"
        echo "Downloading mcp-publisher v${VERSION} from $URL"
        
        # Download with error checking
        if ! curl -Lf "$URL" -o mcp-publisher.tar.gz; then
          echo "❌ Failed to download mcp-publisher from $URL"
          echo "Trying latest release..."
          # Try latest release
          LATEST_URL="https://github.com/modelcontextprotocol/registry/releases/latest/download/mcp-publisher_${OS}_${ARCH}.tar.gz"
          if ! curl -Lf "$LATEST_URL" -o mcp-publisher.tar.gz; then
            echo "❌ Alternative download also failed"
            exit 1
          fi
          echo "✅ Downloaded from latest release"
        fi
        
        # Verify download
        if [ ! -f mcp-publisher.tar.gz ]; then
          echo "❌ Download file not found"
          exit 1
        fi
        
        echo "Extracting mcp-publisher..."
        tar -xzf mcp-publisher.tar.gz
        
        # Find the binary (might be in subdirectory or root)
        if [ -f mcp-publisher ]; then
          BINARY_PATH="./mcp-publisher"
        elif [ -f "./mcp-publisher_${OS}_${ARCH}/mcp-publisher" ]; then
          BINARY_PATH="./mcp-publisher_${OS}_${ARCH}/mcp-publisher"
        else
          echo "❌ mcp-publisher binary not found after extraction"
          echo "Contents of current directory:"
          ls -la
          echo "Looking for mcp-publisher..."
          find . -name "mcp-publisher" -type f 2>/dev/null || true
          exit 1
        fi
        
        chmod +x "$BINARY_PATH"
        sudo mv "$BINARY_PATH" /usr/local/bin/mcp-publisher
        
        # Verify installation
        if ! command -v mcp-publisher &> /dev/null; then
          echo "❌ mcp-publisher not found in PATH after installation"
          exit 1
        fi
        
        echo "✅ mcp-publisher installed successfully"
        mcp-publisher --version
    
    - name: Authenticate with MCP Registry
      run: |
        echo "Authenticating with MCP Registry using GitHub OIDC..."
        mcp-publisher login github-oidc
        echo "✅ Authentication successful"
    
    - name: Wait for Docker image to be available
      run: |
        # Use validated version (from server.json if mismatch, otherwise from release tag)
        VERSION="${{ steps.validate.outputs.version }}"
        IMAGE_NAME="${{ github.repository }}"
        MAX_ATTEMPTS=30
        ATTEMPT=0
        
        echo "Waiting for Docker image to be available: ghcr.io/${IMAGE_NAME}:${VERSION}"
        echo "This may take a few minutes while the Docker build completes..."
        
        while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
          ATTEMPT=$((ATTEMPT + 1))
          echo "Attempt $ATTEMPT/$MAX_ATTEMPTS: Checking if image exists..."
          
          # Check if image exists using GitHub Container Registry API
          # Note: This checks if the package version exists
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/users/${{ github.repository_owner }}/packages/container/${IMAGE_NAME#*/}/versions" || echo "000")
          
          if [ "$HTTP_CODE" = "200" ]; then
            # Check if specific version tag exists in the versions list
            VERSIONS=$(curl -s \
              -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
              "https://api.github.com/users/${{ github.repository_owner }}/packages/container/${IMAGE_NAME#*/}/versions" | \
              jq -r ".[].metadata.container.tags[]" 2>/dev/null || echo "")
            
            if echo "$VERSIONS" | grep -q "^${VERSION}$"; then
              echo "✅ Docker image ghcr.io/${IMAGE_NAME}:${VERSION} is now available!"
              break
            fi
          fi
          
          if [ $ATTEMPT -eq $MAX_ATTEMPTS ]; then
            echo "⚠️  Docker image not found after $MAX_ATTEMPTS attempts (5 minutes)"
            echo "The Docker build may still be in progress."
            echo "Continuing anyway - if publish fails, wait for Docker build to complete and retry."
          else
            echo "Image not yet available, waiting 10 seconds..."
            sleep 10
          fi
        done
    
    - name: Publish to MCP Registry
      id: publish
      run: |
        echo "Publishing to MCP Registry..."
        echo "Server name from server.json:"
        jq -r '.name' server.json
        echo "Repository URL:"
        jq -r '.repository.url' server.json
        echo "Version from server.json:"
        jq -r '.version' server.json
        
        if [ "${{ steps.validate.outputs.version_mismatch }}" == "true" ]; then
          echo "⚠️  Note: Using version from server.json ($(jq -r '.version' server.json)) instead of release tag (${{ steps.version.outputs.version }})"
        fi
        
        # Try to publish with verbose output
        if mcp-publisher publish --verbose 2>&1; then
          echo "✅ Successfully published to MCP Registry"
          echo "published=true" >> $GITHUB_OUTPUT
        else
          EXIT_CODE=$?
          echo "❌ Failed to publish to MCP Registry (exit code: $EXIT_CODE)"
          echo "published=false" >> $GITHUB_OUTPUT
          
          # Note about repository rename
          echo ""
          echo "Note: This server uses the new name after repository rename:"
          echo "Old name: io.github.rosch100/mcp-sqlite"
          echo "New name: io.github.rosch100/mcp-encrypted-sqlite"
          echo ""
          echo "The server will be published as a NEW entry with the new name."
          echo "The old entry (mcp-sqlite) will remain in the registry."
          echo ""
          echo "If the error was about missing Docker image, wait for the Docker build"
          echo "to complete and then manually trigger this workflow again."
          
          exit $EXIT_CODE
        fi
    
    - name: Verify publication
      if: steps.publish.outputs.published == 'true'
      run: |
        SERVER_NAME=$(jq -r '.name' server.json)
        echo "Verifying publication for: $SERVER_NAME"
        
        # Wait a moment for registry to update
        sleep 5
        
        # Try to verify via API (if available)
        if curl -s "${REGISTRY_URL}/v0/servers?search=${SERVER_NAME}" | grep -q "${SERVER_NAME}"; then
          echo "✅ Server found in registry"
        else
          echo "⚠️  Could not verify via API, but publish succeeded"
        fi
    

